<!DOCTYPE html>
<html lang="kh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ការស្នើសុំច្បាប់</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
      }

      h2 {
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div
      class="container"
      style="
        background-color: rgb(243, 243, 243);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2),
          0 6px 20px 0 rgba(0, 0, 0, 0.19);
      "
    >
      <img
        src="https://i.ibb.co/6RVBXRb/Logo-Van-Van-1.png"
        alt=""
        width="100px"
        style="margin: auto; display: block; top: 0"
      />
      <h2 style="text-decoration: underline">ស្នើសុំច្បាប់</h2>
      <form id="legalRequestForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="name" style="font-family: kh Muol"
            >ឈ្មោះ៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <input
            type="text"
            class="form-control"
            style="
              border: 1px solid goldenrod;
              padding: 10px;
              border-radius: 8px;
            "
            id="name"
            placeholder="បញ្ចូលឈ្មោះរបស់អ្នក"
            required
          />
        </div>
        <div class="form-group">
          <label for="legalType" style="font-family: kh Muol"
            >ប្រភេទច្បាប់៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <select
            class="form-control"
            style="
              border: 1px solid goldenrod;
              padding: 5px;
              border-radius: 8px;
            "
            id="legalType"
            required
          >
            <option value="" disabled selected>ជ្រើសរើសប្រភេទច្បាប់</option>
            <option value="សម្រាកដោយជំងឺ">សម្រាកដោយជំងឺ</option>
            <option value="សម្រាកសម្រាកអាពាហ៍ពិពាហ៍">
              សម្រាកសម្រាកអាពាហ៍ពិពាហ៍
            </option>
            <option value="សម្រាកកម្មវិធីបុណ្យសព្វ">
              សម្រាកកម្មវិធីបុណ្យសព
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="legalType" style="font-family: kh Muol"
            >ចំនួនថ្ងៃ៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <select
            class="form-control"
            style="
              border: 1px solid goldenrod;
              padding: 5px;
              border-radius: 8px;
            "
            id="DateType"
            required
          >
            <option value="" disabled selected>ជ្រើសរើសចំនួនថ្ងៃសុំ</option>
            <option value="0,5/ថ្ងៃ">0,5/ថ្ងៃ</option>
            <option value="1/ថ្ងៃ">1/ថ្ងៃ</option>
            <option value="1,5/ថ្ងៃ">1,5/ថ្ងៃ</option>
            <option value="2/ថ្ងៃ">2/ថ្ងៃ</option>
            <option value="2,5/ថ្ងៃ">2,5/ថ្ងៃ</option>
            <option value="3/ថ្ងៃ">3/ថ្ងៃ</option>
            <option value="3,5/ថ">3,5/ថ្ងៃ</option>
            <option value="4/ថ្ងៃ">4/ថ្ងៃ</option>
            <option value="4,5/ថ្ងៃ">4,5/ថ្ងៃ</option>
            <option value="5/ថ្ងៃ">5/ថ្ងៃ</option>
            <option value="5,5/ថ្ងៃ">5,5/ថ្ងៃ</option>
            <option value="6/ថ្ងៃ">6/ថ្ងៃ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="startDateTime" style="font-family: kh Muol"
            >ថ្ងៃចាប់ផ្តើម៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <input
            type="datetime-local"
            class="form-control"
            style="
              border: 1px solid goldenrod;
              padding: 10px;
              border-radius: 8px;
            "
            id="startDateTime"
            required
          />
        </div>
        <div class="form-group">
          <label for="endDateTime" style="font-family: kh Muol"
            >ថ្ងៃបញ្ចប់៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <input
            type="datetime-local"
            class="form-control"
            style="
              border: 1px solid goldenrod;
              padding: 10px;
              border-radius: 8px;
            "
            id="endDateTime"
            required
          />
        </div>

        <div class="form-group" style="position: relative; top: -0.5rem">
          <label for="phone" style="font-family: kh Muol"
            >លេខទូរស័ព្ទ:<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <input
            type="tel"
            class="form-control"
            style="
              border: 1px solid goldenrod;
              padding: 10px;
              border-radius: 8px;
            "
            id="phone"
            placeholder="បញ្ចូលលេខទូរស័ព្ទ"
            required
          />
        </div>

        <div class="form-group" style="position: relative; top: -0.5rem">
          <label for="Warehouse" style="font-family: kh Muol"
            >ទីតាំងឃ្លាំង៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <select
            class="form-control"
            style="
              border: 1px solid goldenrod;
              padding: 5px;
              border-radius: 8px;
              font-family: Kh Siemreap;
            "
            id="Warehouse"
            required
          >
            <option value="" disabled selected>ជ្រើសរើសទីតាំងឃ្លាំង</option>
            <option value="ការិយាល័យកណ្តាល">ការិយាល័យកណ្តាល</option>
            <option value="ស្ទឹងមានជ័យ១">ស្ទឹងមានជ័យ១</option>
            <option value="ចម្រើនផល១">ចម្រើនផល១</option>
            <option value="ចំការដូង">ចំការដូង</option>
          </select>
        </div>
        <style>
          input[type="file"] {
            position: relative;
            top: -2rem;
            align-items: center;
            padding: 10px;
            border: 1px solid goldenrod;
            border-radius: 8px;
          }
        </style>
        <div
          class="mass"
          style="display: none; position: relative; z-index: 1; bottom: 1rem"
        >
          <!-- <div style="background-color: rgb(0, 0, 0); width: 100%; height: 20vh; border-radius: 20px 30px;">Hi</div> -->
          <p
            style="
              font-size: 13px;
              background-color: azure;
              padding: 10px;
              border-radius: 30px 1px;
              box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2),
                0 6px 20px 0 rgba(0, 0, 0, 0.19);
              width: 80%;
            "
          >
            គឺសំដៅលើឯកសារភ្ជាប់នៃការស្នើរសុំរបស់អ្នកផ្សេងៗរបស់អ្នក។<br />ឧទារហណ៍៖
            ឯកសារបញ្ជក់ដូចជា៖<br />ឈឺ,អាពាហ៍ពិពាហ៍,បុណ្យ,ផ្សេងៗ<br />*សូមបញ្ជូលឯកសារទាំងអស់នោះមកកាន់
            HR ដើម្បីត្រួតពិនិត្យ
          </p>
        </div>
        <div class="form-group" style="position: relative; top: -0.5rem">
          <h6 style="font-family: kh Muol">
            រូបភាពឯកសារយោង៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            >
            <p
              class="Bulbsignal"
              style="
                display: inline-flex;
                align-items: center;
                position: relative;
              "
            >
              <a
                href="#"
                style="
                  text-align: end;
                  justify-content: end;
                  position: relative;
                  top: -0.3rem;
                "
                ><img
                  src="https://cdn-icons-png.flaticon.com/512/702/702797.png"
                  alt=""
                  width="20px"
              /></a>
            </p>
          </h6>
          <label for="imageFile"></label>
          <input
            type="file"
            class="form-control-file"
            id="imageFile"
            accept="image/*"
            required
          />
        </div>
        <div class="form-group bg" style="position: relative; top: -2rem">
          <label for="description" style="font-family: kh Muol"
            >ពិពណ៌នាពីច្បាប់៖<span
              class="required"
              style="color: red; font-weight: bold; margin: 3px"
              >*</span
            ></label
          >
          <textarea
            class="form-control"
            id="description"
            rows="4"
            style="
              border: 1px solid goldenrod;
              padding: 10px;
              border-radius: 8px;
            "
            placeholder="ពិពណ៌នាពីច្បាប់ដែលអ្នកស្នើសុំ"
            required
          ></textarea>
        </div>
        <button
          type="submit"
          class="btn btn-primary btn-block"
          style="position: relative; top: -2rem"
        >
          ស្នើសុំ
        </button>
        <!-- <style>
                .btn:hover{
                    transform: scale(0.98);
                    transition: all 0.3s ease-in-out;
                }
            </style> -->
      </form>
      <div id="responseMessage" class="mt-3" style="display: none"></div>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      $(document).ready(function () {
        $(".Bulbsignal").click(function () {
          $(".mass").slideToggle(300);
        });
      });
    </script>
    <script>
      // Function to get selected checkboxes
      function getSelectedWarehouses() {
        var selected = [];
        var checkboxes = document.querySelectorAll(
          'input[name="Warehouse"]:checked'
        );
        checkboxes.forEach(function (checkbox) {
          selected.push(checkbox.value);
        });
        console.log("ទីតាំងឃ្លាំងដែលបានជ្រើស: ", selected);
      }

      // Add event listener for checking and getting values
      document
        .querySelectorAll('input[name="Warehouse"]')
        .forEach(function (checkbox) {
          checkbox.addEventListener("change", getSelectedWarehouses);
        });

      const botAToken = "7797004720:AAEMEXVl4BnZvkcNBCRu0gYNO6Du0zYbPyw"; // Replace with Bot A Token
      const botAChatId = "-1002453800696"; // Replace with Bot A Chat ID
      const botBToken = "7610209447:AAGCR4RLKi3N4t-no2tod7ZWzErNmmkOTms"; // Replace with Bot B Token
      const botBChatId = "-4603693451"; // Replace with Bot B Chat ID

      document
        .getElementById("legalRequestForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const name = document.getElementById("name").value;
          const phone = document.getElementById("phone").value;
          const legalType = document.getElementById("legalType").value;
          const description = document.getElementById("description").value;
          const Warehouse = document.getElementById("Warehouse").value;
          const DateType = document.getElementById("DateType").value;
          const imageFile = document.getElementById("imageFile").files[0];
          const startDateTime = document.getElementById("startDateTime").value;
          const endDateTime = document.getElementById("endDateTime").value;

          const responseMessage = document.getElementById("responseMessage");
          responseMessage.style.display = "none"; // Hide response message initially

          const formData = new FormData();
          formData.append("chat_id", botAChatId);
          formData.append("photo", imageFile);

          // Prepare the keyboard
          const keyboard = {
            inline_keyboard: [
              [
                { text: "អនុម័ត", callback_data: `approve|${name}` },
                { text: "បដិសេធ", callback_data: `reject|${name}` },
              ],
            ],
          };

          // Show popup message while sending data
          const sendingPopup = document.createElement("div");
          sendingPopup.innerHTML = `
            <div style="position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000;">
                <h4 style="font-family: kh Muol;">កំពុងបញ្ជូន...</h4>
                <p>សូមរង់ចាំ...</p>
            </div>
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
            `;
          document.body.appendChild(sendingPopup);

          // Send the message to Bot A with the inline keyboard
          fetch(`https://api.telegram.org/bot${botAToken}/sendPhoto`, {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              console.log("Message Sent to Bot A:", data);

              // Now send the text message with the keyboard
              fetch(`https://api.telegram.org/bot${botAToken}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  chat_id: botAChatId,
                  text: `\nឈ្មោះ៖ ${name}\nលេខទូរស័ព្ទ៖ ${phone}\nទីតាំងឃ្លាំង៖ ${Warehouse}\nប្រភេទច្បាប់៖ ${legalType}\nចំនួនថ្ងៃ៖ ${DateType}\nពីថ្ងៃទី៖ ${new Date(
                    startDateTime
                  ).toLocaleDateString("en-GB")} ${new Date(
                    startDateTime
                  ).toLocaleString("en-US", {
                    hour: "numeric",
                    minute: "numeric",
                    hour12: true,
                  })}\nដល់ថ្ងៃទី៖ ${new Date(endDateTime).toLocaleDateString(
                    "en-GB"
                  )} ${new Date(endDateTime).toLocaleString("en-US", {
                    hour: "numeric",
                    minute: "numeric",
                    hour12: true,
                  })}\nមូលហេតុ៖ ${description}`,
                  reply_markup: keyboard,
                }),
              })
                .then((res) => res.json())
                .then((data) => {
                  console.log("Message with keyboard Sent to Bot A:", data);

                  // Show success message only after all data is sent
                  responseMessage.style.display = "block";
                  responseMessage.classList.add("alert", "alert-success");
                  responseMessage.textContent =
                    "ការស្នើសុំរបស់អ្នកត្រូវបានបញ្ជូនដោយជោគជ័យ។";

                  // Remove popup after data is sent
                  sendingPopup.remove();

                  // Store form data in localStorage
                  localStorage.setItem(
                    "formData",
                    JSON.stringify({
                      name,
                      phone,
                      legalType,
                      description,
                      Warehouse,
                      DateType,
                    })
                  );
                })
                .catch((err) => {
                  console.error("Error sending message with keyboard:", err);
                  responseMessage.style.display = "block";
                  responseMessage.classList.add("alert", "alert-danger");
                  responseMessage.textContent =
                    "មានបញ្ហាក្នុងការបញ្ជូនទិន្នន័យ។ សូមព្យាយាមម្តងទៀត។";
                  sendingPopup.remove();
                });
            })
            .catch((err) => {
              console.error("Error sending photo:", err);
              responseMessage.style.display = "block";
              responseMessage.classList.add("alert", "alert-danger");
              responseMessage.textContent =
                "មានបញ្ហាក្នុងការបញ្ជូនរូបភាព។ សូមព្យាយាមម្តងទៀត។";
              sendingPopup.remove();
            });
        });

      // Load form data from localStorage on page load
      window.addEventListener("load", function () {
        const savedData = JSON.parse(localStorage.getItem("formData"));
        if (savedData) {
          document.getElementById("name").value = savedData.name;
          document.getElementById("phone").value = savedData.phone;
          document.getElementById("legalType").value = savedData.legalType;
          document.getElementById("description").value = savedData.description;
          document.getElementById("Warehouse").value = savedData.Warehouse;
          document.getElementById("DateType").value = savedData.DateType;
        }
      });

      async function pollTelegramUpdates() {
        let offset = 0;

        while (true) {
          try {
            const response = await fetch(
              `https://api.telegram.org/bot${botAToken}/getUpdates?offset=${offset}`
            );
            const data = await response.json();

            if (data.ok && data.result.length > 0) {
              data.result.forEach((update) => {
                console.log("Update:", update);

                if (update.callback_query) {
                  handleCallbackQuery(update.callback_query);
                }

                offset = update.update_id + 1;
              });
            }
          } catch (error) {
            console.error("Polling Error:", error);
          }
        }
      }

      // Handle the callback query
      function handleCallbackQuery(callbackQuery) {
        const callbackData = callbackQuery.data.split("|");
        const action = callbackData[0]; // approve or reject
        const requesterName = callbackData[1]; // Requester's name

        const userMessage =
          action === "approve"
            ? `សួស្តី! ${requesterName} ការស្នើរសុំរបស់អ្នកត្រូវបានអនុម័ត។✅ `

        // Send the message to Bot B
        fetch(`https://api.telegram.org/bot${botBToken}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: botBChatId,
            text: userMessage,
          }),
        })
          .then((res) => res.json())
          .then((data) => console.log("Message Sent to Bot B:", data))
          .catch((err) => console.error("Error:", err));
      }

      // Start polling for updates immediately
      pollTelegramUpdates();
      // Show auto popup message when the website is opened
      window.addEventListener("load", function () {
        const autoPopup = document.createElement("div");
        autoPopup.innerHTML = ` 
            <div style="position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000;">
                <h4 style="font-family: kh Muol;">សូមស្វាគមន៍!</h4>
                <p>សូមបំពេញទម្រង់ស្នើសុំច្បាប់របស់អ្នកឱ្យបានត្រឹមត្រូវ<br>សូមរង់ចាំរហូតដល់ទិន្នន័យរបស់អ្នកបានបញ្ជូនរួចរាល់។</p>
            
            </div>
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
            `;
        document.body.appendChild(autoPopup);
        // Auto close the popup after 10 seconds
        setTimeout(function () {
          autoPopup.remove();
        }, 2000);
      });
      // Auto reload the page every 30 seconds
    </script>
  </body>
</html>
