<!DOCTYPE html>
<html lang="km">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fingerprint Check-In/Out System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* Custom styles */
      .card-body {
        background-color: #f0f0f08e;
        box-shadow: 0px 0px 1px 1px #6161618c;
        border-radius: 8px;
        border: 1px solid #080052;
      }

      .action-info p {
        font-size: 1.2rem;
      }

      .action-info .label {
        font-weight: bold;
      }

      .action-info .value {
        color: blue;
      }

      .map-link {
        word-wrap: break-word;
      }

      .status-message {
        font-size: 1.3rem;
        font-weight: bold;
        color: #dc3545;
      }

      .modal-dialog {
        max-width: 450px;
      }

      .btn {
        width: 100%;
        background-color: #007bff;
        color: white;
      }

      .btn:disabled {
        opacity: 0.6;
      }

      .main-header {
        font-family: "Arial", sans-serif;
        color: #343a40;
      }

      .card-title mark {
        /* background-color: #ffc107; */
        color: #212529;
        font-size: 12px;
      }
      @keyframes popUp {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        50% {
          transform: scale(1.1);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .pop-up {
        animation: popUp 0.5s ease-out;
        display: inline-block; /* Ensures animation works properly for inline text */
        font-size: 1.2em; /* Adjust as needed */
        font-weight: bold;
        color: #4caf50; /* Success green */
      }
      /* Base styles for the alert */
      .alert {
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #4caf50; /* Green background */
        color: white;
        padding: 20px 30px;
        font-size: 1.2em;
        font-weight: bold;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      }

      /* Show alert */
      .alert.show {
        opacity: 1;
        pointer-events: auto;
        transform: translate(-50%, -50%) scale(1);
      }

      /* Hidden state */
      .alert.hidden {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
        font-weight: bold;
        background-image: url(https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExbmJyMzlpczlwdXczMzBhMHg5MWl5bnNtcTNoamlzeGVyN3NsazlsdyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/hpF9R9M1PHN5e5liSx/giphy.gif);
      }
    </style>
    <script>
      // Function to generate a unique device token (UUID)
      function generateDeviceToken() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      // Function to store and check the device token
      function checkAccess() {
        // List of allowed tokens
        const allowedTokens = [
          // 'c0818665-8f91-45da-a3e4-8bd45bcdf85a', // Bath PC
          // "3a4a9420-367c-43ea-b6a0-0191f0a24548", // Bath PC
          'c9dd4a16-c845-4eaa-a3c3-a95e122daae8',  // Bath(Telegram)
          '94f3417a-d4fc-422b-b22f-5bf20f307d04',  // Bath(Chrome)
          // '785f1442-339a-4d58-8212-4268905550a0',  // sarun(Chrome)
          // '1963c4c3-5795-4c37-84a1-b68db1ddfd03'  // Cheat(PC)
        ];
        let deviceToken = localStorage.getItem("device_token");

        // If no token exists, generate one and store it
        if (!deviceToken) {
          deviceToken = generateDeviceToken();
          localStorage.setItem("device_token", deviceToken);
        }

        // Check if the stored token matches any of the allowed tokens
        if (allowedTokens.includes(deviceToken)) {
          document.getElementById("access-granted").style.display = "block";
          document.getElementById("access-denied").style.display = "none";
          document.getElementById("popup").style.display = "none";
          document.getElementById("export-section").style.display = "block"; // Show the export section
        } else {
          document.getElementById("access-granted").style.display = "none";
          document.getElementById("access-denied").style.display = "block";
          document.getElementById("export-section").style.display = "none"; // Hide the export section
        }
      }

      // Run the checkAccess function when the page loads
      window.onload = checkAccess;

      // Function to handle the export of user data to CSV
      function exportUserDataToCSV() {
        const userName = document.getElementById("userNameSelect").value;
        const startDate = document.getElementById("startDateSelect").value;
        const endDate = document.getElementById("endDateSelect").value;

        const usersData = [
          { userName: "user1", date: "2024-01-01", data: "Some data" },
          { userName: "user2", date: "2024-01-02", data: "Some more data" },
        ];

        const filteredData = usersData.filter((user) => {
          const userDate = new Date(user.date);
          return (
            (userName === "all" || user.userName === userName) &&
            (!startDate || userDate >= new Date(startDate)) &&
            (!endDate || userDate <= new Date(endDate))
          );
        });

        let csvContent = "User Name, Date, Data\n";
        filteredData.forEach((user) => {
          csvContent += `${user.userName}, ${user.date}, ${user.data}\n`;
        });

        const blob = new Blob([csvContent], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "user_data.csv";
        link.click();
      }
    </script>
  </head>

  <body>
    <h1
      id="access-denied"
      class="text-center"
      style="display: flex; padding: 100px 0"
    >
      á¢áŸ’á“á€á˜á·á“á¢á¶á…á”á¾á€áŸáŸ’á€áŸá“á”á¶á“á‘áŸ!
    </h1>
    <div
      id="popup"
      style="display: block; text-align: center; top: -5rem; position: relative"
    >
      <a href="#"
        ><img
          src="https://cdn-icons-png.flaticon.com/512/5728/5728403.png"
          alt=""
          width="100px"
      /></a>
    </div>
    <div class="Bulbsignal" style="display: none">
      <span
        style="
          display: flex;
          align-items: center;
          margin: auto;
          justify-content: center;
          background-color: whitesmoke;
          width: 80%;
          border-radius: 8px;
          padding: 20px;
          position: relative;
          top: -5rem;
          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2),
            0 6px 20px 0 rgba(0, 0, 0, 0.19);
        "
      >
        1. áá¾á€á¶ášá”á¾á€á“áŸáŸ‡ááŸ’ášá¹á˜ááŸ’ášá¼áœáŠáŸ‚ášá¬á‘áŸ?<br />2. áá¾á¢áŸ’á“á€á”á¶á“á‡áŸ’ášá¾áŸášá¾áŸ Web Browser
        ááŸ’ášá¹á˜ááŸ’ášá¼áœáŠáŸ‚ášá¬á‘áŸ?<br />"Chrome,Safari,"<br />3.
        áá¾á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá”á¶á“á”áŸ’ášá¶á”áŸ‹á¢áŸ’á“á€á¢á¶á…á”áŸ’ášá¾á”á¶á“á“áŸ…á€áŸ’á“á»á„á€á˜áŸ’á˜áœá·á’á¸á˜á½á™áá¶?<br />"Chrome
        or Safari"
        <style>
          .Bulbsignal button:hover {
            transform: scale(0.98);
            transition: all 0.3s ease-in-out;
          }
        </style>
        <a href="https://t.me/Sao_Som_Bath" target="_blank"
          ><button
            style="
              border: none;
              outline: none;
              background-color: #007bff;
              border-radius: 8px;
              padding: 10px;
              position: absolute;
              top: 14rem;
              left: 0;
              color: white;
            "
          >
            á‘áŸ†á“á¶á€áŸ‹á‘á„á˜á€á€á¶á“áŸ‹ IT <i class="fa-brands fa-telegram"></i></button
        ></a>
        <img
          src="https://cdn0.iconfinder.com/data/icons/colourful-education/250/bulb-512.png"
          alt=""
          width="50px"
          style="
            display: flex;
            position: relative;
            top: -5rem;
            align-items: end;
            z-index: 1;
            right: -10px;
          "
        />
      </span>
    </div>

    <p
      id="access-granted"
      style="
        color: green;
        font-weight: bold;
        display: none;
        text-align: center;
        position: absolute;
      "
    ></p>
    <p id="access-denied" style="color: red; font-weight: bold; display: none">
      áŸá¼á˜á¢á—áŸá™á‘áŸ„áŸ! á¢áŸ’á“á€á˜á·á“á˜á¶á“áŸá·á‘áŸ’á’á·á…á¼á›á”áŸ’ášá¾á‘áŸ!
    </p>

    <section id="export-section" style="display: none">
      <div class="container mt-5 main-header">
        <h1 class="text-center main-content" style="text-decoration: underline;">Fingerprint Check-In/Out</h1>
        <div class="card mt-4">
            <div class="card-body">

        <!-- User Name Input -->
         <style>
          .hidename option{
            display: none;
          }
         </style>
        <div class="mb-3 mt-4">
          <label for="userNameInput" class="form-label d-none">á‡áŸ’ášá¾áŸášá¾áŸá¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</label>
          <select id="userNameInput" class="form-select hidename" required>
            <option value="áŸáŸ… áŸá˜áŸ’á”ááŸ’áá·">áŸáŸ… áŸá˜áŸ’á”ááŸ’áá·(0163)</option>
            <!-- <option value="áŒá¹á˜ áŸá»á‡á¶áá·">áŒá¹á˜ áŸá»á‡á¶áá·(0158)</option>
            <option value="áŸáŸ€á„ áŸá¶ášá»á“">áŸáŸ€á„ áŸá¶ášá»á“(0151)</option>
            <option value="á†á“ ášááŸ’áá“áŸˆ">á†á“ ášááŸ’áá“áŸˆ(0243)</option>
            <option value="á˜áŸ‰á»á› á“á¸áá¶">á˜áŸ‰á»á› á“á¸áá¶(0242)</option>
            <option value="áŸá¹á˜ áŸá»á">áŸá¹á˜ áŸá»á(0250)</option>
            <option value="á•á¼ áŸá»áá“á¸">á•á¼ áŸá»áá“á¸(0254)</option>
            <option value="á¡áŸá„ áŒá¿á“">á¡áŸá„ áŒá¿á“(0169)</option>
            <option value="áœááŸ’á áŠá¶ááŸ‚á">áœááŸ’á áŠá¶ááŸ‚á(0172)</option>
            <option value="áœáŸ‰á¶á“áŸ‹ áŸá¶ášáŸ‰áŸá">áœáŸ‰á¶á“áŸ‹ áŸá¶ášáŸ‰áŸá(0062)</option>
            <option value="á‚áº á‘áºá€á¡á¶">á‚áº á‘áºá€á¡á¶(0183)</option>
            <option value="á›á¸ áŸáŸŠá¶á„á¢á»á¸">á›á¸ áŸáŸŠá¶á„á¢á»á¸(0224)</option>
            <option value="áœááŸ’á áŠá¶ááŸ‚á">áœááŸ’á áŠá¶ááŸ‚á(0172)</option>
            <option value="á˜áŸ‰á»á„ áŠá¶á›á¸á“">á˜áŸ‰á»á„ áŠá¶á›á¸á“(0066)</option>
            <option value="á—á¿á“ áŠá¶á›á¸á“">á—á¿á“ áŠá¶á›á¸á“(0016)</option>
            <option value="á”á¿á“ á€á‰áŸ’á‰á¶">á”á¿á“ á€á‰áŸ’á‰á¶(0238)</option> -->
          </select>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!-- Include Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script>

$(document).ready(function () {
                  $("#popup").on("click", function () {
                    $(".Bulbsignal").fadeToggle(500);
                  });
                });
// Get the visit count and last visit timestamp from localStorage
let visitCount = localStorage.getItem('visitCount');
        let lastVisitTime = localStorage.getItem('lastVisitTime');
        const currentTime = new Date().getTime(); // Current time in milliseconds

        // If there's no last visit timestamp, initialize the visit count
        if (!lastVisitTime) {
            lastVisitTime = currentTime;
            visitCount = 0; // Start fresh with 0 visits
        }

        // Check if 1 minute has passed since the last visit
        const timeDifference = currentTime - lastVisitTime;
        const oneMinute = 60 * 100; // 1 minute in milliseconds

        if (timeDifference > oneMinute) {
            // Reset visit count after 1 minute
            visitCount = 1;
            lastVisitTime = currentTime; // Update last visit time
        } else {
            // Increment visit count if within the same minute window
            visitCount = parseInt(visitCount) + 1;
        }

        // Update localStorage with new visit count and timestamp
        localStorage.setItem('visitCount', visitCount);
        localStorage.setItem('lastVisitTime', lastVisitTime);

        // Check if the visit count exceeds 4
        if (visitCount > 1) {
            document.body.innerHTML = "<div style='color: blue; text-align: center; margin-top: 20%; padding: 20px; font-family: Arial, sans-serif; animation: fadeIn 1s ease-in-out; font-weight: bold;'><h1>Something is wrong</h1><img src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRWHkYf_5eipWHQENpVlXxxWujD295xKSKvqy74zeN0e1mwWo4WCmUC7bZZoPmitQ1eWQ8&usqp=CAU' alt='Error Robot' style='width: 200px; margin-top: 20px;'></div>";
            // Optionally, you can redirect or block further page interaction
        }

        // Add keyframes for fadeIn animation
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
            }
        `;
        document.head.appendChild(styleSheet);

            $(document).ready(function() {
                // $('#userNameInput').select2({
                //     placeholder: "á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€!",
                //     allowClear: true
                // }).on('change', function() {
                //     const userName = $(this).val();
                //     if (userName) {
                //         $('#scanFingerprint').prop('disabled', true);
                //     } else {
                //         $('#scanFingerprint').prop('disabled', true);
                //     }
                // });
            });
            $(document).ready(function() {
              // $('#userNameInput').select2({
              //   placeholder: "á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€!",
              //   allowClear: true
              // }).on('change', function() {
              //   const userName = $(this).val();
              //   if (userName) {
              //     $('#requestEarlyScan').prop('disabled', true);
              //   } else {
              //     $('#requestEarlyScan').prop('disabled', true);
              //   }
              // });

              // Hide the requestEarlyScan button for 1 minute on page load
              $('#requestEarlyScan').hide();
              setTimeout(function() {
                $('#requestEarlyScan').show();
                }, 2592000000); // 30 days = 2592000000 milliseconds
              $('#idSelect').hide();
              $('#departmentSelect').hide();
              $('#PositionSelect').hide();
              $('#BranchSelect').hide();
              $('.hidename').hide();
      
            });
        </script>
        </div>
        <!-- Action Selection Dropdown -->
        <div class="mb-3">
          <label for="actionSelect" class="form-label">á‡áŸ’ášá¾áŸášá¾áŸá”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“ </label>
          <select id="actionSelect" class="form-select" required>
            <option value="Check-In">áŸáŸ’á€áŸá“á…á¼á›</option>
            <option value="Check-Out">áŸáŸ’á€áŸá“á…áŸá‰</option>
          </select>
        </div>
        <!-- ID Selection Dropdown -->
         <style>
          .ID{
            position: absolute;
          }
          .DT{
            position: absolute;
          }
          .PT{
            position: absolute;
          }
          .BH{
            position: absolute;
          }
         </style>
        <div class="mb-3">
          <label for="idSelect" class="form-label ID"></label>
          <select id="idSelect" class="form-select" required>
            <option value="0163">0163</option>
            <!-- Add more options as needed -->
          </select>
        </div>
        <div class="mb-3">
          <label for="idSelect" class="form-label DT"></label>
          <select id="departmentSelect" class="form-select" required>
            <option value="IT">IT</option>
            <!-- Add more options as needed -->
          </select>
        </div>
        <div class="mb-3">
          <label for="idSelect" class="form-label PT"></label>
          <select id="PositionSelect" class="form-select" required>
            <option value="IT SUPPORT">IT SUPPORT</option>
            <!-- Add more options as needed -->
          </select>
        </div>
        <div class="mb-3">
          <label for="idSelect" class="form-label BH"></label>
          <select id="BranchSelect" class="form-select" required>
            <option value="Head Office">Head Office</option>
            <!-- Add more options as needed -->
          </select>
        </div>
        <button id="scanFingerprint" class="btn btn-primary mb-3">á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸáŸ’á€áŸá“</button>
        <button id="requestEarlyScan" class="btn btn-warning mb-3 d-none">áŸáŸ’á“á¾ášáŸá»áŸ†áŸáŸ’á€áŸá“á˜á»á“</button>
        

        <!-- Action Information -->
        <div class="action-info">
          <p><span class="label">á”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“áŸ–</span> <span id="action" class="value">N/A</span></p>
          <p><span class="label">ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„áŸ–</span> <span id="timestamp" class="value">N/A</span></p>
          <p><span class="label">á€á¶ášá…á¶á”áŸ‹á‘á¸áá¶áŸ†á„ášá”áŸáŸ‹á¢áŸ’á“á€áŸ–</span> <span id="location" class="value">á€áŸ†á–á»á„áŸáŸ’á€áŸá“á‘á¸áá¶áŸ†á„</span></p>
          <p><span class="label">á‘á¸áá¶áŸ†á„ášá”áŸáŸ‹á¢áŸ’á“á€áŸ–</span> <a id="mapLink" class="map-link" href="#" target="_blank">View
              on Map</a></p>
        </div>
        <!-- Status Message -->
        <p id="status" class="status-message text-muted">ášá„á…á¶áŸ†á€á¶ášáŸáŸ’á€áŸá“ášá”áŸáŸ‹á¢áŸ’á“á€...</p>
      </div>
    </div>
    <!-- Request Early Scan Button -->
    <!-- <button id="requestEarlyScan" class="btn btn-warning mb-3">áŸáŸ’á“á¾ášáŸá»áŸ†áŸáŸ’á€áŸá“á˜á»á“</button> -->

    <script>
      // Function to start face scan
      function startFaceScan() {
        const video = document.createElement('video');
        video.setAttribute('autoplay', '');
        video.setAttribute('playsinline', '');
        document.body.appendChild(video);

        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
        };
          })
          .catch(error => {
        console.error('Error accessing camera:', error);
        alert('á˜á·á“á¢á¶á…á…á¼á›á”áŸ’ášá¾á€á¶á˜áŸášáŸ‰á¶á”á¶á“á‘áŸ!');
          });

        // Placeholder for face recognition logic
        // You can integrate a face recognition library here
        // For example, using face-api.js or any other library

        // Simulate face scan success after 5 seconds
        setTimeout(() => {
          alert('áŸáŸ’á€áŸá“á˜á»áá”á¶á“á‡áŸ„á‚á‡áŸá™!');
          video.srcObject.getTracks().forEach(track => track.stop());
          document.body.removeChild(video);

          // Collect the form data
          const userName = document.getElementById('userNameInput').value.trim();
          const action = document.getElementById('actionSelect').value;
          const currentTimeFormatted = new Date().toLocaleString();
          const location = `Lat: ${currentLatitude.toFixed(5)}, Long: ${currentLongitude.toFixed(5)}`;

          const formData = new FormData();
          formData.append("áˆáŸ’á˜áŸ„áŸ‡", userName);
          formData.append("á”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“", action);
          formData.append("ááŸ’á„áŸƒ", new Date().toLocaleDateString());
          formData.append("á˜áŸ‰áŸ„á„", new Date().toLocaleTimeString());
          formData.append("location", location);

          const keyValuePairs = [];
          for (const pair of formData.entries()) {
        keyValuePairs.push(pair[0] + "=" + pair[1]);
          }

          const formDataString = keyValuePairs.join("&");

          // Send a POST request to your Google Apps Script
          fetch(
        "https://script.google.com/macros/s/AKfycbyS-hk5UE2BJsDcZ9eshieZOcncGDTJWrnYN3cMmFj5hlFFnoBKnm1e5nX3p0A_V1xFKQ/exec",
        {
          redirect: "follow",
          method: "POST",
          body: formDataString,
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
        }
          )
        .then(response => {
          if (response) {
            return response; // Assuming your script returns JSON response
          } else {
            throw new Error("Failed to submit the form.");
          }
        })
        .then(data => {
          // Display a success message
          const statusElement = document.getElementById("status");
          statusElement.textContent = "á”á¶á“á”á‰áŸ’á‡á¼á“ášá½á…ášá¶á›áŸ‹";
          statusElement.style.display = "block";
          statusElement.style.backgroundColor = "gold";
          statusElement.style.color = "beige";

          setTimeout(() => {
            statusElement.textContent = "";
            statusElement.style.display = "none";
          }, 2600);

          // Send message to Telegram
          sendToTelegram(`áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**${action}**\n\nááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„ áŸ– ${currentTimeFormatted}\ná‘á¸áá¶áŸ†á„ áŸ– ${location}`);
        })
        .catch(error => {
          console.error(error);
          alert("An error occurred while submitting the form.");
        });
        }, 5000);
      }

      // Add event listener to the scan button
      window.addEventListener('load', startFaceScan);
  
        document.getElementById('requestEarlyScan').addEventListener('click', function() {
            const userName = document.getElementById('userNameInput').value.trim();
            if (!userName) {
            alert("áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€á‡á¶á˜á»á“áŸá·á“!");
            return;
            }
            const currentTimeFormatted = new Date().toLocaleString();
            const message = `áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**áŸáŸ’á“á¾ášáŸá»áŸ†áŸáŸ’á€áŸá“á˜á»á“**\n\ná”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“ áŸ– ${document.getElementById('actionSelect').value}\n ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„ áŸ– ${currentTimeFormatted}`;
            
            // Send message to Telegram
            sendToTelegram(message);

            // Collect the form data
            var action = document.getElementById('actionSelect').value;
            var location = `Lat: ${currentLatitude.toFixed(5)}, Long: ${currentLongitude.toFixed(5)}`;
            var formData = new FormData();
            var customDate = new Date(); // Use current date and time or set a custom one
            var date = customDate.toLocaleDateString(); // Get the date part
            var time = customDate.toLocaleTimeString(); // Get the time part

            formData.append("áˆáŸ’á˜áŸ„áŸ‡", userName);
            formData.append("á”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“", action);
            formData.append("ááŸ’á„áŸƒ", date); // Add the date
            formData.append("á˜áŸ‰áŸ„á„", time); // Add the time
            formData.append("location", location);

            var keyValuePairs = [];
            for (var pair of formData.entries()) {
            keyValuePairs.push(pair[0] + "=" + pair[1]);
            }

            var formDataString = keyValuePairs.join("&");

            // Send a POST request to your Google Apps Script
            fetch(
            "https://script.google.com/macros/s/AKfycbyS-hk5UE2BJsDcZ9eshieZOcncGDTJWrnYN3cMmFj5hlFFnoBKnm1e5nX3p0A_V1xFKQ/exec",
            {
                redirect: "follow",
                method: "POST",
                body: formDataString,
                headers: {
                "Content-Type": "text/plain;charset=utf-8",
                },
            }
            )
            .then(function (response) {
            // Check if the request was successful
            if (response) {
                return response; // Assuming your script returns JSON response
            } else {
                throw new Error("Failed to submit the form.");
            }
            })
            .then(function (data) {
            // Display a success message with animation
            const statusElement = document.getElementById("status");
            statusElement.textContent = "áŸáŸ†áá¾ášá”áŸáŸ‹á¢áŸ’á“á€ááŸ’ášá¼áœá”á¶á“á”á‰áŸ’á‡á¼á“!";
            statusElement.classList.add('pop-up');
            statusElement.style.display = "block";
            statusElement.style.backgroundColor = "gold";
            statusElement.style.color = "white";
            statusElement.style.transition = "opacity 0.5s ease-in-out";
            statusElement.style.opacity = "1";

            // Hide the message after 3 seconds with fade-out effect
            setTimeout(() => {
                statusElement.style.opacity = "0";
                setTimeout(() => {
                    statusElement.style.display = "none";
                }, 500); // Match the transition duration
            }, 3000);
            document.getElementById("status").style.display = "block";
            document.getElementById("status").style.backgroundColor = "gold";
            document.getElementById("status").style.color = "white";
            })
            .catch(function (error) {
            // Handle errors, you can display an error message here
            console.error(error);
            alert("An error occurred while submitting the form.");
            });
        });
    </script>
  </div>
  
  <script>
    const userState = {};

    // Allowed location and tolerance
        // const allowedLatitude = 11.55089;
        // const allowedLongitude = 104.91219;
        // const tolerance = 0.001;
        // const allowedRadius = 0.001;
    // Get user's location
    const locationElement = document.getElementById('location');
    const mapLinkElement = document.getElementById('mapLink');
    const scanButton = document.getElementById('scanFingerprint');

    let isWithinBounds = false;
    let currentLatitude = 0;
    let currentLongitude = 0;


    // if (locationElement.textContent.includes("á€áŸ†á–á»á„áŸáŸ’á€áŸá“á‘á¸áá¶áŸ†á„")) {
    //     scanButton.style.display = 'none';
    //     document.getElementById('requestEarlyScan').style.display = 'none';
    // } else {
    //     scanButton.style.display = 'block';
    //     document.getElementById('requestEarlyScan').style.display = 'block';
    // }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          currentLatitude = latitude;
          currentLongitude = longitude;

          locationElement.textContent = `Lat: ${latitude.toFixed(5)}, Long: ${longitude.toFixed(5)}`;
          mapLinkElement.href = `https://www.google.com/maps?q=${latitude},${longitude}`;

          // Check if user is within allowed location bounds
          isWithinBounds =
            Math.abs(latitude - allowedLatitude) <= tolerance &&
            Math.abs(longitude - allowedLongitude) <= tolerance;

          if (!isWithinBounds) {
            locationElement.textContent += " (á‘á¸áá¶áŸ†á„á“áŸáŸ‡á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœá‘áŸ!)";
            mapLinkElement.textContent = "á˜á·á“á¢á¶á…áŸáŸ’á€áŸá“á‘á¸áá¶áŸ†á„á”á¶á“á‘áŸ!";
            scanButton.style.display = 'none'; // Hide the button if location is incorrect
            alert("á¢áŸ’á“á€á˜á·á“á¢á¶á…áŸáŸ’á€áŸá“á”á¶á“á‘áŸ! áŸá¼á˜á˜á€á€á“áŸ’á›áŸ‚á„á’áŸ’áœá¾á€á¶ášášá”áŸáŸ‹á¢áŸ’á“á€áŸá·á“! á”áŸ’ášá‰á¶á”áŸ‹á¡á¾á„!");
          } else {
            scanButton.style.display = 'block'; // Show the button if location is correct
          }
        },
        () => {
          locationElement.textContent = "á˜á·á“á¢á¶á…á™á€á‘á¸áá¶áŸ†á„á“áŸáŸ‡á”á¶á“á‘áŸ!";
          mapLinkElement.textContent = "áŸá¼á˜á…á»á…ááŸ’ášá„áŸ‹á“áŸáŸ‡áŠá¾á˜áŸ’á”á¸á”á¾á€á‘á¸áá¶áŸ†á„";
          mapLinkElement.href = "#";
          scanButton.style.display = 'none'; // Hide the button if location cannot be fetched
        }
      );
    } else {
      locationElement.textContent = "Geolocation is not supported by this browser.";
      mapLinkElement.textContent = "á•áŸ‚á“á‘á¸á˜á·á“á˜á¶á“á‘áŸáŸ”";
      mapLinkElement.href = "#";
      scanButton.style.display = 'none'; // Hide the button if geolocation is not supported
    }

    document.getElementById("scanFingerprint").addEventListener("click", function (e) {
      e.preventDefault(); // Prevent the default form submission
      document.getElementById("status").textContent = "á€áŸ†á–á»á„á”á‰áŸ’á‡á¼á“";
      document.getElementById("status").style.display = "block";
      document.getElementById("scanFingerprint").disabled = true;

      // Collect the form data
      var userName = document.getElementById('userNameInput').value.trim();
      var action = document.getElementById('actionSelect').value;
      var timestamp = new Date().toLocaleString();
      var customDate = new Date(); // Use current date and time or set a custom one
      var date = customDate.toLocaleDateString(); // Get the date part
      var time = customDate.toLocaleTimeString(); // Get the time part
      var location = `Lat: ${currentLatitude.toFixed(5)}, Long: ${currentLongitude.toFixed(5)}`;

      var formData = new FormData();

          formData.append("áˆáŸ’á˜áŸ„áŸ‡", userName);
          formData.append("á”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“", action);
          formData.append("ááŸ’á„áŸƒ", date); // Add the date
          formData.append("á˜áŸ‰áŸ„á„", time); // Add the time
          formData.append("location", location);

      var keyValuePairs = [];
      for (var pair of formData.entries()) {
        keyValuePairs.push(pair[0] + "=" + pair[1]);
      }

      var formDataString = keyValuePairs.join("&");

      // Send a POST request to your Google Apps Script
      fetch(
        "https://script.google.com/macros/s/AKfycbyS-hk5UE2BJsDcZ9eshieZOcncGDTJWrnYN3cMmFj5hlFFnoBKnm1e5nX3p0A_V1xFKQ/exec",
        {
          redirect: "follow",
          method: "POST",
          body: formDataString,
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
        }
      )
        .then(function (response) {
          // Check if the request was successful
          if (response) {
            return response; // Assuming your script returns JSON response
          } else {
            throw new Error("Failed to submit the form.");
          }
        })
        .then(function (data) {
          // Display a success message
          document.getElementById("status").textContent = "á”á¶á“á”á‰áŸ’á‡á¼á“ášá½á…ášá¶á›áŸ‹";
          document.getElementById("status").style.display = "block";
          document.getElementById("status").style.backgroundColor = "gold";
          document.getElementById("status").style.color = "beige";
          document.getElementById("scanFingerprint").disabled = false;

          setTimeout(function () {
            document.getElementById("status").textContent = "";
            document.getElementById("status").style.display = "none";
          }, 2600);
        })
        .catch(function (error) {
          // Handle errors, you can display an error message here
          console.error(error);
          document.getElementById("status").textContent = "An error occurred while submitting the form.";
          document.getElementById("status").style.display = "block";
        });
    });

    // Function to send a message to the Telegram bot
    function sendToTelegram(message) {
      const url = `https://api.telegram.org/bot7205851039:AAHBOJmY40GvNl7M0X_FN9Ml0Fg2T_KQpb8/sendMessage`;
      const data = {
        chat_id: "-1002282814819", // Chat ID
        text: message
      };

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(data => {
          console.log("Message sent to Telegram:", data);
        })
        .catch(error => {
          console.error("Error sending message to Telegram:", error);
        });
    }

    document.getElementById('scanFingerprint').addEventListener('click', () => {
      const scanButton = document.getElementById('scanFingerprint');
      scanButton.disabled = true; // Disable the button immediately
      scanButton.style.display = 'none'; // Hide the button

      // Store the time when the button is clicked in localStorage
      localStorage.setItem("buttonStateTime", Date.now());

      const action = document.getElementById('actionSelect').value; // Get selected action (Check-In or Check-Out)

      const statusElement = document.getElementById('status');
      const actionElement = document.getElementById('action');
      const timestampElement = document.getElementById('timestamp');

      // Get the entered user name
      const userName = document.getElementById('userNameInput').value.trim();

      if (!userName) {
        alert("áŸá¼á˜á”á‰áŸ’á‡á¼á›áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€");
        scanButton.disabled = false; // Re-enable the button in case of missing name
        scanButton.style.display = 'block'; // Show the button again
        localStorage.removeItem("buttonStateTime"); // Reset localStorage
        return;
      }

      // Get the current time
      const currentTime = new Date();
      const currentTimeFormatted = currentTime.toLocaleString();

      const scanTime = currentTime.getHours() * 60 + currentTime.getMinutes(); // Convert current time to minutes
let scanStatus = "ğŸ”µGood"; // Default status

// Define time ranges
const ranges = [
  { start: 6 * 60, end: 8 * 60 , status: "ğŸ”µGood" }, // 6:00 AM - 7:30 AM
  { start: 8 * 60 + 1, end: 11 * 60 + 59, status: "ğŸ”´Late" }, // 7:31 AM - 10:59 AM
  { start: 12 * 60, end: 13 * 60, status: "ğŸ”µGood" }, // 11:00 AM - 12:00 PM
  { start: 13 * 60 + 1, end: 16 * 60 + 59, status: "ğŸ”´Late" }, // 12:01 PM - 4:59 PM
  { start: 17 * 60, end: 24 * 60, status: "ğŸ”µGood" }, // 5:00 PM onward
];

// Determine scan status
for (const range of ranges) {
  if (scanTime >= range.start && scanTime <= range.end) {
    scanStatus = range.status;
    break;
  }
}
      // Get the user's address using reverse geocoding
           fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLatitude}&lon=${currentLongitude}`,
                    {
                        headers: {
                            "Accept-Language": "km",
                        },
                    }
                )
                    .then((response) => response.json())
                    .then((data) => {
                        const address = data.address.road || "á˜á·á“á¢á¶á…ášá€á‘á¸áá¶áŸ†á„á”á¶á“";
          // Set action as per selected action (Check-In or Check-Out)
          if (action === "Check-Out") {
            userState[userName] = "Check-Out";
            statusElement.textContent = `áŸáŸ†áá¶á„á›áŸ’á¢, ${userName}! ${scanStatus}`;
            actionElement.textContent = "Check-Out";

            // Send message to Telegram bot with full map link and address
            const mapLink = `https://www.google.com/maps?q=${currentLatitude},${currentLongitude}`;
            sendToTelegram(`áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**Checked out**\n\nStatus: ${scanStatus}\n\nID: ${document.getElementById('idSelect').value}\nDepartment: ${document.getElementById('departmentSelect').value}\nPosition: ${document.getElementById('PositionSelect').value}\nBranch: ${document.getElementById('BranchSelect').value}\nááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„ áŸ– ${currentTimeFormatted}\ná‘á¸áá¶áŸ†á„ áŸ– ${address}\n[á˜á¾á›á‘á¸áá¶áŸ†á„] ${mapLink}`);
          } else {
            userState[userName] = "Check-In";
            statusElement.textContent = `áŸá¼á˜áŸáŸ’áœá¶á‚á˜á“áŸ, ${userName}! ${scanStatus}`;
            actionElement.textContent = "Check-In";

            // Send message to Telegram bot with full map link and address
            const mapLink = `https://www.google.com/maps?q=${currentLatitude},${currentLongitude}`;
            sendToTelegram(`áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**Checked in**\n\nStatus: ${scanStatus}\n\nID: ${document.getElementById('idSelect').value}\nDepartment: ${document.getElementById('departmentSelect').value}\nPosition: ${document.getElementById('PositionSelect').value}\nBranch: ${document.getElementById('BranchSelect').value}\nááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„ áŸ– ${currentTimeFormatted}\ná‘á¸áá¶áŸ†á„ áŸ– ${address}\n[á˜á¾á›á‘á¸áá¶áŸ†á„] ${mapLink}`);
          }

          timestampElement.textContent = currentTimeFormatted;

          // Save user data to localStorage
          const userData = JSON.parse(localStorage.getItem("userData")) || [];
          userData.push({
            userName,
            action,
            timestamp: currentTimeFormatted,
            location: { latitude: currentLatitude, longitude: currentLongitude },
            status: scanStatus,
            address
          });
          localStorage.setItem("userData", JSON.stringify(userData));

          // Reload the page after 1 minute to hide the button
          setTimeout(() => {
            window.location.href = window.location.href;
          }, 60000); // 45 minutes = 2700000 milliseconds
        })
        .catch(error => {
          console.error("Error fetching address:", error);
        });
      // Set action as per selected action (Check-In or Check-Out)
      // if (action === "Check-Out") {
      //   userState[userName] = "Check-Out";
      //   statusElement.textContent = `áŸáŸ†áá¶á„á›áŸ’á¢, ${userName}! ${scanStatus}`;
      //   actionElement.textContent = "Check-Out";

      //   // Send message to Telegram bot with full map link
      //   const mapLink = `https://www.google.com/maps?q=${currentLatitude},${currentLongitude}`;
      //   sendToTelegram(`áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**Checked out**\n\nStatus: ${scanStatus}\n\nID: ${document.getElementById('idSelect').value}\nDepartment: ${document.getElementById('departmentSelect').value}\nPosition: ${document.getElementById('PositionSelect').value}\nBranch: ${document.getElementById('BranchSelect').value}\nááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„ áŸ– ${currentTimeFormatted}\n[á˜á¾á›á‘á¸áá¶áŸ†á„] ${mapLink}`);
      // } else {
      //   userState[userName] = "Check-In";
      //   statusElement.textContent = `áŸá¼á˜áŸáŸ’áœá¶á‚á˜á“áŸ, ${userName}! ${scanStatus}`;
      //   actionElement.textContent = "Check-In";

      //   // Send message to Telegram bot with full map link
      //   const mapLink = `https://www.google.com/maps?q=${currentLatitude},${currentLongitude}`;
      //   sendToTelegram(`áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**Checked in**\n\nStatus: ${scanStatus}\n\nID: ${document.getElementById('idSelect').value}\nDepartment: ${document.getElementById('departmentSelect').value}\nPosition: ${document.getElementById('PositionSelect').value}\nBranch: ${document.getElementById('BranchSelect').value}\nááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ† áŸ– ${currentTimeFormatted}\n[á˜á¾á›á‘á¸áá¶áŸ†á„] ${mapLink}`);
      // }

      timestampElement.textContent = currentTimeFormatted;

      // Save user data to localStorage
      const userData = JSON.parse(localStorage.getItem("userData")) || [];
      userData.push({
        userName,
        action,
        timestamp: currentTimeFormatted,
        location: { latitude: currentLatitude, longitude: currentLongitude },
        status: scanStatus
      });
      localStorage.setItem("userData", JSON.stringify(userData));

      // Reload the page after 1 minute to hide the button
      setTimeout(() => {
        window.location.href = window.location.href;
      }, 60000); // 45 minutes = 2700000 milliseconds
    });

    // Check the button state on page load
    window.addEventListener('load', () => {
      const buttonStateTime = localStorage.getItem("buttonStateTime");
      if (buttonStateTime) {
        const elapsedTime = Date.now() - buttonStateTime;
        if (elapsedTime < 600) { // 1 minute = 60000 milliseconds
          document.getElementById('scanFingerprint').disabled = true;
          document.getElementById('scanFingerprint').style.display = 'none';
        } else {
          localStorage.removeItem("buttonStateTime");
        }
      }
    });

    // Disable the scan button if no name is selected
    document.getElementById('userNameInput').addEventListener('change', function () {
      const userName = this.value.trim();
      if (userName) {
        scanButton.disabled = false;
      } else {
        scanButton.disabled = true;
      }
    });

    // Save displayed data to localStorage before reloading the page
    window.addEventListener('beforeunload', () => {
      const displayedData = {
        action: document.getElementById('action').textContent,
        timestamp: document.getElementById('timestamp').textContent,
        location: document.getElementById('location').textContent,
        mapLink: document.getElementById('mapLink').href,
        status: document.getElementById('status').textContent
      };
      localStorage.setItem('displayedData', JSON.stringify(displayedData));
    });

    // Restore displayed data from localStorage on page load
    window.addEventListener('load', () => {
      const displayedData = JSON.parse(localStorage.getItem('displayedData'));
      if (displayedData) {
        document.getElementById('action').textContent = displayedData.action;
        document.getElementById('timestamp').textContent = displayedData.timestamp;
        document.getElementById('location').textContent = displayedData.location;
        document.getElementById('mapLink').href = displayedData.mapLink;
        document.getElementById('status').textContent = displayedData.status;
      }
    });
      </script>
    </section>
  </body>
</html>
